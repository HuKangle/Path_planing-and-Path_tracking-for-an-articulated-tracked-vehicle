xx = xx(200:end);
yy = yy(200:end);
vxx = vxx(200:end);
vyy = vyy(200:end);
axx = axx(200:end);
ayy = ayy(200:end);
tt = T_total(200:end);
% xx = smooth(xx,100,'rloess');
% yy = smooth(yy,100,'rloess');
vxx_rloess = smooth(vxx,10,'rlowess');
vyy_rloess = vyy;
vyy_rloess = smooth(vyy,5,'rlowess');
yaw_rloess = atan2(vyy,vxx);
axx_rloess = smooth(axx, 20,'rlowess');
ayy_rloess = smooth(ayy, 100,'rloess');
vxx_rloess = vxx;
vyy_rloess = vyy;
axx_rloess = axx;
ayy_rloess = ayy;
yaw = smooth(yaw_rloess,10,'rlowess');
d_yaw= smooth(diff(yaw_rloess)./diff(tt),100,'rloess');
d= 2.3;
L= 5;
dyaw = (ayy_rloess./vxx_rloess-axx_rloess.*vyy_rloess./vxx_rloess.^2)./(1+(vyy_rloess./vxx_rloess).^2);
d_yaw = smooth((ayy_rloess./vxx_rloess-axx_rloess.*vyy_rloess./vxx_rloess.^2)./(1+(vyy_rloess./vxx_rloess).^2),10,'rloess');
% d_yaw_smooth = smooth((ayy_rloess./vxx_rloess-axx_rloess.*vyy_rloess./vxx_rloess.^2)./(1+(vyy_rloess./vxx_rloess).^2),100,'rloess');
% K_smooth = (vxx_rloess.*ayy_rloess-axx_rloess.*vyy_rloess)./(vxx_rloess.*vxx_rloess+vyy_rloess.*vyy_rloess).^(3/2);

K_smooth = smooth((vxx_rloess.*ayy_rloess-axx_rloess.*vyy_rloess)./(vxx_rloess.*vxx_rloess+vyy_rloess.*vyy_rloess).^(3/2),100,'rloess');
vr = sqrt((vxx_rloess).^2+(vyy_rloess).^2);
vr = smooth(sqrt((vxx_rloe'ss).^2+(vyy_rloess).^2),10,'rlowess');
% Psi_smooth = yaw_rloess-asin(L*d_yaw_smooth./ vr);

% omeg = d_yaw_smooth + vr./sqrt(vr.^2-d^2*d_yaw_smooth.^2);
plan_path= load('point_xy19.mat');
y = plan_path.path.y;
delta = plan_path.path.delta;
% psi1 = cumsum(d_psi);
% psi2 = cumsum(d_psi_de);
% yaw  = cumsum(d_yaw_smooth);
delta_snap = interp1(y,delta,yy,'linear');
psi_delta = yaw_rloess-delta_snap;
% xx = planed_path(:,2);
% yy = planed_path(:,3);
d_psi = 2*vr.*delta_snap'/L-d_yaw_smooth;
% yaw_rloess = planed_path(:,4);
% psi = planed_path(:,5);
% d_psi_de = smooth(diff(psi)./diff(T_total'),10,'rlowess');
omegaf = d_yaw(1:4600); 
gamma = delta_snap(1:4600)';
vf  = vr(1:4600)';
L1 = 2.3; L2 = 2.7;
dgama = (omegaf.*(L1*cos(gamma)+L2)-vf.*sin(gamma))/L2;
d_gama = smooth(dgama,20,'rlowess');
x_  = xx(1:4600)';
y_  = yy(1:4600)';
yaw_ = yaw_rloess(1:4600)';
psi_ = psi_delta(1:4600)';
planned_path = [vf x_ y_ yaw_ psi_ omegaf gamma d_gama];
t_total = tt(1:4600);
% planed_path = [vr xx yy yaw_rloess psi_delta d_yaw_smooth delta_snap];